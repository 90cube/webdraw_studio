# AI 이미지 웹앱 상세 기획서

## 1. 프로젝트 개요

본 문서는 Vanilla JS, Fabric.js, Three.js를 프론트엔드로, ComfyUI 기반 시스템을 백엔드로 활용하여 전문가 수준의 AI 이미지 생성 및 편집 웹 애플리케이션을 구축하기 위한 상세 기획서입니다. 사용자의 창의성을 극대화하기 위해 **플로팅 UI 패널**, **이중 캔버스 시스템**, **실시간 파이프라인 탐지** 등 고도의 기능을 포함한 아키텍처를 제안합니다.

## 2. 핵심 아키텍처

### 2.1. 3대 구성 요소

1. **플로팅 UI 패널 (Floating UI Panels)**: 사용자가 모든 기능을 제어하는 독립적인 '도구 상자'입니다. 각 패널은 헤더를 드래그하여 자유롭게 위치를 조절할 수 있으며, 헤더의 토글 버튼으로 패널을 접거나 펼쳐 작업 공간을 효율적으로 관리할 수 있습니다. 순수 HTML/JS/CSS로 구현됩니다.

2. **메인 캔버스 (Main Canvas - Staging View)**: 여러 이미지 레이어의 전체적인 구성을 관리하는 '준비 공간'입니다. Fabric.js 기반으로, 이미지의 위치, 크기, 순서 등 거시적인 조작을 담당합니다.

3. **에디트 캔버스 (Edit Canvas - Workshop View)**: 단일 이미지를 세밀하게 편집하고 전처리하는 '집중 작업실'입니다. 메인 캔버스에서 특정 레이어를 선택하고 '편집' 모드로 진입했을 때 활성화되는 별도의 뷰입니다.

### 2.2. 백엔드 파일 시스템

ComfyUI 표준을 따르되, 프론트엔드에서의 명확한 모델 구분을 위해 다음과 같은 중첩 구조를 사용합니다.

- `/models/checkpoints/sd15/`

- `/models/checkpoints/sdxl/sdxl/`

- `/models/checkpoints/sdxl/pdxl/`

- `/models/checkpoints/sdxl/ilxl/`

- `/models/loras/sd15/`

- `/models/loras/sdxl/character/`

- `/models/vae/`

- `/models/preprocessors/`

- `/models/yolo/`

- `/models/presets/` (Pos, Neg, parameters)

> **Checkpoint 및 LoRA 폴더 구조 설계 원칙:**
> 
> Checkpoint와 LoRA 폴더를 위와 같이 세분화한 이유는 **파일 경로 자체를 데이터로 활용하여 시스템의 자동화와 안정성을 높이기 위함**입니다.
> 
> 1. **자동 모델 타입 감지**: 백엔드 스캐너는 `.../sdxl/pdxl/` 와 같은 경로를 분석하여 해당 모델이 'SDXL' 기반의 'pdxl' 타입임을 자동으로 인식합니다. 이를 통해 프론트엔드는 복잡한 로직 없이 모델의 특성을 파악하고 사용자에게 명확한 정보를 제공할 수 있습니다.
> 
> 2. **파이프라인 자동 선택**: 감지된 모델 타입(SD15, SDXL 등)은 백엔드에서 올바른 생성 파이프라인(예: SDXL Refiner 사용 여부)을 선택하는 핵심적인 기준으로 사용됩니다. 이는 사용자가 직접 파이프라인을 설정하는 번거로움을 없애고 오류 가능성을 줄여줍니다.
> 
> 3. **체계적인 UI 제공**: 이 폴더 구조는 프론트엔드의 '모델 탐색기' 및 'LoRA 선택기' 패널에서 직관적인 계층형 트리 뷰를 구성하는 데 그대로 사용되어 일관된 사용자 경험을 제공합니다.
> 
> *참고: 현재 설계에서는 위 경로보다 더 깊은 하위 폴더는 시스템에서 별도로 구분하지 않습니다.*

> **프리셋 폴더 구조 원칙:**
> 
> `presets` 폴더를 `Pos` (긍정 프롬프트), `Neg` (부정 프롬프트), `parameters` (생성 파라미터)로 세분화한 이유는 **역할에 따라 데이터를 명확하게 분리하여 관리의 효율성을 높이기 위함**입니다. 각 UI 패널은 자신의 역할에 맞는 데이터만(예: 프롬프트 패널은 Pos/Neg 폴더만) 정확하고 빠르게 불러올 수 있어 시스템의 확장성과 유지보수성이 크게 향상됩니다.

### 2.3. 데이터베이스 설계 (SQL)

#### 2.3.1. 설계 철학

데이터베이스는 파일 시스템의 '메타데이터 인덱스' 역할을 수행합니다. 파일 스캔을 통해 물리적인 파일 정보를 구조화된 데이터로 변환하여, 프론트엔드가 빠르고 효율적으로 필요한 정보를 조회할 수 있도록 지원합니다. 또한, 모든 생성 기록을 저장하여 데이터의 영속성을 보장하고 향후 기능 확장의 기반을 마련합니다.

#### 2.3.2. 테이블 스키마

**1. `Models` 테이블**

- **설명**: 파일 시스템의 `/models` 폴더 내 모든 AI 모델 파일의 메타데이터를 저장합니다.

- **컬럼**:
  
  - `model_id` (INT, PK, AUTO_INCREMENT): 고유 식별자.
  
  - `file_name` (VARCHAR(255), NOT NULL): 순수 파일 이름.
  
  - `file_path` (TEXT, NOT NULL, UNIQUE): 저장소 루트 기준 상대 경로. 이 경로를 기준으로 UPSERT(UPDATE or INSERT) 작업을 수행합니다.
  
  - `model_type` (VARCHAR(50)): `checkpoints`, `loras` 등 최상위 폴더 이름. **(인덱스 추천)**
  
  - `base_model` (VARCHAR(50)): `sd15`, `sdxl` 등 두 번째 레벨 폴더 이름. **(인덱스 추천)**
  
  - `sub_type` (VARCHAR(255), NULL): `pdxl`, `character` 등 세 번째 레벨 이하의 경로.
  
  - `preview_path` (TEXT, NULL): 모델과 이름이 같은 `.png` 파일의 경로.
  
  - `metadata` (JSON, NULL): PNG 파일에서 추출한 Civitai 메타데이터.
  
  - `created_at` (TIMESTAMP, DEFAULT CURRENT_TIMESTAMP): 레코드 생성 시각.

**2. `Generations` 테이블**

- **설명**: 사용자가 생성한 모든 이미지의 상세 정보를 기록합니다. (UI에 히스토리 패널이 없더라도, 백엔드 로깅 및 추후 분석을 위해 필수적입니다.)

- **컬럼**:
  
  - `generation_id` (INT, PK, AUTO_INCREMENT): 고유 식별자.
  
  - `output_path` (TEXT, NOT NULL): 생성된 이미지 파일의 경로.
  
  - `prompt` (TEXT): 사용된 긍정 프롬프트.
  
  - `negative_prompt` (TEXT): 사용된 부정 프롬프트.
  
  - `parameters` (JSON): Seed, Steps, CFG, Sampler 등 생성에 사용된 모든 파라미터.
  
  - `used_models` (JSON): 사용된 Checkpoint, VAE, LoRA들의 `model_id`를 배열 형태로 저장.
  
  - `created_at` (TIMESTAMP, DEFAULT CURRENT_TIMESTAMP): 생성 완료 시각.

#### 2.3.3. 주요 SQL 쿼리 예시

**1. UI용 모델 목록 조회 (프론트엔드 요청)**

- SDXL 기반의 `pdxl` 타입 Checkpoint 목록을 가져올 때:
  
  ```
  SELECT file_name, file_path, preview_path
  FROM Models
  WHERE model_type = 'checkpoints' AND base_model = 'sdxl' AND sub_type = 'pdxl';
  ```

**2. 모델 파일 스캔 후 DB 업데이트 (백엔드 스크립트)**

- 백엔드 스크립트가 `my_model.safetensors` 파일을 발견했을 때, 이미 DB에 있는지 확인하고 없으면 추가, 있으면 업데이트(UPSERT)합니다.
  
  ```
  -- PostgreSQL 예시
  INSERT INTO Models (file_path, file_name, model_type, base_model, sub_type)
  VALUES ('checkpoints/sdxl/pdxl/my_model.safetensors', 'my_model.safetensors', 'checkpoints', 'sdxl', 'pdxl')
  ON CONFLICT (file_path)
  DO UPDATE SET file_name = EXCLUDED.file_name;
  ```

**3. 이미지 생성 후 기록 저장 (백엔드 API)**

- 이미지 생성이 완료된 후, 사용된 모든 정보를 `Generations` 테이블에 기록합니다.
  
  ```
  INSERT INTO Generations (output_path, prompt, negative_prompt, parameters, used_models)
  VALUES (
      '/output/2025-08-26/result_001.png',
      'a beautiful landscape',
      'blurry, low quality',
      '{"seed": 12345, "steps": 25, "cfg": 7.5, "sampler": "Euler a"}',
      '{"checkpoint": 101, "vae": 205, "loras": [310, 315]}'
  );
  ```

## 3. 플로팅 UI 패널 상세 설계

### 3.1. 좌측 패널

- **패널 1: 모델 탐색기 (좌상단)**
  
  - **역할**: Checkpoint와 VAE 모델 선택.
  
  - **UI**: `checkpoints`, `vae` 폴더 구조를 반영한 계층형 트리 뷰. 모델 선택 시 하단에 PNG 미리보기 표시.

- **패널 2: 파라미터 (좌중단)**
  
  - **역할**: 이미지 생성 핵심 수치 제어.
  
  - **UI**:
    
    - **모델 상태**: `[SDXL]` 등 현재 모델의 기반 타입 표시.
    
    - **비율 토글**: 모델 상태에 맞는 해상도 프리셋 제공 (`16:9` ↔ `9:16`).
    
    - **입력**: 샘플러, 스케쥴러, 스텝, 배치 수.
    
    - **프리셋**: `presets/parameters` 폴더의 JSON 파일을 읽어 파라미터 세트를 불러오는 토글 버튼.

### 3.2. 하단 패널

- **패널 3: 프롬프트 프리셋 (하단 좌측)**
  
  - **역할**: 저장된 프롬프트 추가.
  
  - **UI**: `presets/Pos`, `presets/Neg` 폴더의 JSON 파일을 읽어 버튼 생성. 클릭 시 **기존 프롬프트에 내용이 추가됨.**

- **패널 4: LoRA 선택기 (하단 우측)**
  
  - **역할**: LoRA 활성화 및 트리거 워드 추가.
  
  - **UI**: `loras` 폴더 구조를 반영한 **계층형 트리 뷰**로 표시. 트리거 워드(`.txt` 파일)가 있는 경우 LoRA 이름 옆에 `T` 버튼 추가. 클릭 시 **긍정 프롬프트에 내용이 추가됨.**

- **패널 5: 실행 제어 (중앙 하단)**
  
  - **UI**: CFG (0-20, 기본값 5), Denoise (0-1, 기본값 1)를 제어하는 세로 슬라이더.

### 3.3. 우측 패널

- **패널 6: 영역 캡처 (우상단)**
  
  - **역할**: 메인 캔버스 영역을 SD 비율로 캡처.
  
  - **UI**: 모드 전환(Select/Rectangle), SD 비율 선택 드롭다운, 선택 정보 표시, `Capture`/`Paste` 버튼, 캡처 미리보기.

- **패널 7: 다중 디테일러 (우측 중앙)**
  
  - **역할**: 여러 단계의 Detailer를 순차적으로 적용.
  
  - **UI**:
    
    - `+ Add Detailer Stage` 버튼으로 스테이지 추가.
    
    - 각 스테이지는 독립적으로 YOLO 모델, Confidence, 전용 프롬프트를 설정.
    
    - 드래그 앤 드롭으로 순서 변경 및 삭제 가능.

### 3.4. 중앙 상단 패널

- **패널 8: 생성 실행기 (중앙 상단)**
  
  - **역할**: 최종 생성 명령을 내리고, 생성 큐를 관리하며, 현재 구성된 작업 파이프라인을 사용자에게 시각적으로 알려줍니다.
  
  - **UI**:
    
    - **[ GENERATE ]** 버튼: 생성 프로세스를 시작합니다.
    
    - **[ STOP ]** 버튼: 생성 중에 활성화되며, 현재 진행 중인 모든 작업을 즉시 중단합니다.
    
    - **생성 횟수**: 실행할 횟수를 지정하는 숫자 입력 필드.
    
    - **무제한 반복 (`∞`)**: 라디오 버튼 또는 토글 스위치. 활성화 시 '생성 횟수' 입력 필드는 비활성화됩니다.
    
    - **파이프라인 표시줄**: 버튼 하단에 위치하며, 현재 감지된 파이프라인을 텍스트로 실시간 표시합니다. (예: `Image to Image -> Inpaint -> Detailer (Face)`)

## 4. 에디트 캔버스 (Edit Canvas) 상세 설계

메인 캔버스에서 레이어 선택 후 '편집' 모드로 진입 시 활성화되는 뷰. 좌측에 3개의 모드 전환 탭이 존재.

### 4.1. 모드 1: 이미지 편집

- **기능**: 자유 그리기, 도형 등 일반 페인팅 툴로 이미지 리터칭.

- **결과**: `확인` 시, 편집된 내용이 새로운 이미지 레이어로 생성. 이 레이어만 선택 시 `Image to Image` 파이프라인 감지.

### 4.2. 모드 2: 마스크 편집

- **기능**: 전용 브러쉬/도형 툴로 마스크 영역 지정. 브러쉬의 블러(Feather), 투명도(Opacity) 조절 가능.

- **결과**: `확인` 시, 원본과 동일한 크기의 흑백 마스크 이미지가 새 레이어로 생성. 원본과 마스크를 함께 선택 시 `Inpaint` 파이프라인 감지.

### 4.3. 모드 3: 전처리기

- **기능**: `depth`, `canny`, `openpose` 등 `preprocessors` 폴더의 모델 선택. Resize 방식, Weight, Resolution 등 상세 파라미터 조절.

- **미리보기**: `전처리 실행` 시, 원본과 결과물을 한 화면에서 비교할 수 있는 **드래그 슬라이더** 제공.

- **결과**: `저장` 시, 전처리된 이미지가 메인 캔버스에 새 레이어로 추가됨.

## 5. 핵심 워크플로우

1. **모델 선택**: 사용자는 **패널 1**에서 Checkpoint를 선택. 시스템은 경로를 분석해 `[SDXL]` 등 모델 타입을 **패널 2**에 표시.

2. **생성**: **하단 패널들**과 **패널 2**에서 프롬프트, LoRA, 파라미터를 설정. **패널 8**의 `GENERATE` 버튼으로 이미지 생성.

3. **레이아웃**: 생성된 이미지는 **메인 캔버스**에 레이어로 추가됨. 사용자는 여러 레이어를 배치하고 **패널 6**으로 특정 영역을 캡처해 새 레이어로 만들 수 있음.

4. **편집/전처리**: 특정 레이어를 선택 후 **에디트 캔버스**로 진입. 마스크, ControlNet용 이미지 등을 생성하여 다시 **메인 캔버스**로 가져옴.

5. **재생성 (I2I/Inpaint)**: **메인 캔버스**에서 원본 이미지, 마스크, ControlNet 이미지 등 필요한 레이어들을 함께 선택. **패널 8**은 선택된 조합을 실시간으로 분석해 `Inpaint` 등 파이프라인을 자동으로 표시.

6. **후처리**: **패널 7**에서 다중 디테일러 파이프라인을 설정.

7. **최종 생성 및 중단**:
   
   - **생성**: `GENERATE` 버튼을 누르면, 감지된 파이프라인과 모든 설정값이 백엔드로 전달되어 최종 결과물이 생성됩니다. `STOP` 버튼이 활성화됩니다.
   
   - **중단**: 사용자가 `STOP` 버튼을 누르면, 프론트엔드는 백엔드에 작업 중단 요청을 보냅니다. 백엔드는 현재 큐를 비웁니다. 프론트엔드의 상태는 **`GENERATE` 버튼을 누르기 직전 상태로 완벽하게 복원**됩니다. (로드된 모델 제외) 사용자는 즉시 설정을 변경하거나 다시 생성을 시작할 수 있습니다.
